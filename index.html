<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenant Project Planner</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar styling for aesthetics */
        #projects-list::-webkit-scrollbar {
            width: 8px;
        }
        #projects-list::-webkit-scrollbar-thumb {
            background-color: #a5b4fc; /* Indigo 300 */
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 md:p-8 transform hover:shadow-3xl transition duration-300">
        <!-- Header -->
        <header class="mb-6 border-b pb-4">
            <h1 class="text-4xl font-extrabold text-indigo-700">Tenant Project Board</h1>
            <p class="text-sm text-gray-500 mt-2">Manage your maintenance and upgrade projects in real time.</p>
        </header>

        <!-- New Project Form -->
        <form id="project-form" class="mb-8 flex flex-col sm:flex-row gap-3">
            <input type="text" id="project-title" placeholder="Project name (e.g., 'Fix leaky faucet in Unit 3A')" required
                   class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base transition duration-150">
            <button type="submit" id="add-button"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 ease-in-out shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 disabled:opacity-50 sm:w-auto w-full">
                Add Project
            </button>
        </form>

        <!-- Project List Container -->
        <div id="projects-list" class="space-y-3 max-h-[60vh] overflow-y-auto p-1">
            <p class="text-gray-500 text-center py-8" id="loading-indicator">Initializing Supabase connection...</p>
        </div>

        <!-- Error Message Box -->
        <div id="error-message" class="hidden mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg shadow-md" role="alert">
            <strong class="font-bold">Error:</strong>
            <span id="error-text"></span>
        </div>
    </div>

    <!-- Supabase Client Import -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Application Logic -->
    <script type="module">
        // --- 0. Environment Setup and Globals ---
        
        // Helper function to try accessing environment variables based on common patterns
        const getEnvVar = (name) => {
            // Note: This pattern relies on the build environment (like Vercel with a framework)
            // successfully injecting these variables into the global scope (e.g., import.meta.env).
            // For a plain static site, this might need a custom injection script during build.
            if (typeof import.meta !== 'undefined' && import.meta.env && import.meta.env[name]) {
                return import.meta.env[name];
            }
            // Add a fallback for typical Vercel client-side injection if the VITE prefix is used
            // This relies on the variables being set correctly in Vercel settings.
            if (typeof window !== 'undefined' && window.process && window.process.env && window.process.env[name]) {
                return window.process.env[name];
            }
            return null; 
        };

        // Attempt to read the environment variables
        const SUPABASE_URL = getEnvVar('VITE_SUPABASE_URL');
        const SUPABASE_ANON_KEY = getEnvVar('VITE_SUPABASE_ANON_KEY');

        let supabase = null;
        
        // Element references
        const projectsList = document.getElementById('projects-list');
        const projectForm = document.getElementById('project-form');
        const projectTitleInput = document.getElementById('project-title');
        const loadingIndicator = document.getElementById('loading-indicator');
        const addButton = document.getElementById('add-button');
        const errorBox = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        // Table Name (Must match your Supabase table)
        const PROJECTS_TABLE = 'projects'; 


        /**
         * Displays an error message in the UI.
         * @param {string} message The error message to display.
         */
        function displayError(message) {
            console.error(message);
            errorText.textContent = message;
            errorBox.classList.remove('hidden');
        }

        /**
         * Initializes the Supabase client.
         */
        function initializeSupabase() {
            try {
                if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                    throw new Error("Supabase URL or Anon Key is missing. Ensure VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY are set in Vercel environment variables.");
                }
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                addButton.disabled = false;
                loadingIndicator.textContent = "Projects loading...";
                subscribeToProjects();

            } catch (err) {
                displayError(`Initialization Error: ${err.message}`);
                addButton.disabled = true;
                loadingIndicator.textContent = "Could not connect to the database.";
            }
        }

        // --- 1. REAL-TIME LISTENER ---

        /**
         * Renders the list of projects to the UI.
         * @param {Array<Object>} projects The array of project objects.
         */
        function renderProjects(projects) {
            projectsList.innerHTML = '';
            loadingIndicator.classList.add('hidden');
            
            // Sort by creation date (id) client-side for better UX consistency
            projects.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

            if (projects.length === 0) {
                projectsList.innerHTML = '<p class="text-gray-400 text-center py-8 italic">No projects yet. Add your first task above!</p>';
                return;
            }

            projects.forEach(project => {
                const isComplete = project.is_complete;
                const item = document.createElement('div');
                item.className = `flex items-center justify-between p-4 rounded-xl shadow-md transition duration-200 ease-in-out cursor-pointer hover:shadow-lg ${isComplete ? 'bg-green-50 border-l-4 border-green-500 line-through text-gray-500 opacity-80' : 'bg-white border-l-4 border-indigo-500 text-gray-800 hover:bg-indigo-50'}`;
                item.setAttribute('data-id', project.id);

                item.innerHTML = `
                    <span class="text-base font-medium flex-1 mr-4" id="title-${project.id}">
                        ${project.title}
                    </span>
                    <div class="flex items-center space-x-3">
                        <!-- Toggle Button -->
                        <button class="toggle-btn text-xl transition transform hover:scale-110" data-id="${project.id}" data-status="${isComplete}" title="Toggle Complete">
                            ${isComplete ? '<span class="text-green-600">?</span>' : '<span class="text-gray-400">??</span>'}
                        </button>
                        <!-- Delete Button -->
                        <button class="delete-btn text-xl text-red-500 hover:text-red-700 transition transform hover:scale-110" data-id="${project.id}" title="Delete Project">
                            &times;
                        </button>
                    </div>
                `;
                projectsList.appendChild(item);
            });
            attachEventListeners();
        }

        /**
         * Subscribes to real-time updates from the Supabase table.
         */
        async function subscribeToProjects() {
            try {
                // Initial fetch to populate the list immediately
                const initialFetch = await supabase
                    .from(PROJECTS_TABLE)
                    .select('*');

                if (initialFetch.error) throw initialFetch.error;
                renderProjects(initialFetch.data);

                // Setup Realtime Subscription
                supabase.channel('projects_channel')
                    .on('postgres_changes', { event: '*', schema: 'public', table: PROJECTS_TABLE }, (payload) => {
                        // Re-fetch all data to ensure consistent sorting and state
                        fetchProjects(); 
                    })
                    .subscribe();

            } catch (error) {
                displayError(`Failed to subscribe to projects: ${error.message}`);
            }
        }
        
        /**
         * Fetches all projects from the database.
         */
        async function fetchProjects() {
            try {
                const { data, error } = await supabase
                    .from(PROJECTS_TABLE)
                    .select('*');
                    
                if (error) throw error;
                renderProjects(data);
                
            } catch (error) {
                 displayError(`Failed to fetch projects: ${error.message}`);
            }
        }

        // --- 2. CRUD OPERATIONS & EVENT HANDLERS ---

        /**
         * Handles the form submission to add a new project.
         */
        async function handleAddProject(e) {
            e.preventDefault();
            const title = projectTitleInput.value.trim();

            if (!title) return;

            addButton.disabled = true;
            addButton.textContent = 'Saving...';
            errorBox.classList.add('hidden');

            try {
                const { error } = await supabase
                    .from(PROJECTS_TABLE)
                    .insert([
                        { title: title, is_complete: false }
                    ]);
                
                if (error) throw error;
                
                projectTitleInput.value = ''; // Clear input on success

            } catch (err) {
                displayError(`Failed to add project: ${err.message}`);
            } finally {
                addButton.disabled = false;
                addButton.textContent = 'Add Project';
            }
        }

        /**
         * Toggles the completion status of a project.
         * @param {string} id The document ID (primary key) of the project.
         * @param {boolean} currentStatus The current completion status.
         */
        async function toggleProject(id, currentStatus) {
            errorBox.classList.add('hidden');
            
            try {
                const { error } = await supabase
                    .from(PROJECTS_TABLE)
                    .update({ is_complete: !currentStatus })
                    .eq('id', id);

                if (error) throw error;
                
            } catch (err) {
                displayError(`Failed to toggle project status: ${err.message}`);
            }
        }

        /**
         * Deletes a project document.
         * @param {string} id The document ID (primary key) of the project.
         */
        async function deleteProjectHandler(id) {
            errorBox.classList.add('hidden');
            
            try {
                const { error } = await supabase
                    .from(PROJECTS_TABLE)
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                
            } catch (err) {
                displayError(`Failed to delete project: ${err.message}`);
            }
        }

        /**
         * Attaches event listeners to the dynamically created buttons.
         */
        function attachEventListeners() {
            projectsList.querySelectorAll('.delete-btn').forEach(button => {
                // Ensure existing listeners are removed to prevent duplicates (common in re-rendering)
                button.onclick = null; 
                button.onclick = (e) => {
                    e.stopPropagation(); // Prevent parent toggle
                    deleteProjectHandler(button.getAttribute('data-id'));
                };
            });
            
            projectsList.querySelectorAll('.toggle-btn').forEach(button => {
                // Ensure existing listeners are removed
                button.onclick = null;
                button.onclick = (e) => {
                    e.stopPropagation(); // Prevent parent toggle
                    const id = button.getAttribute('data-id');
                    // Data-status is stored as a string, convert back to boolean
                    const currentStatus = button.getAttribute('data-status') === 'true'; 
                    toggleProject(id, currentStatus);
                };
            });
        }

        // --- 3. STARTUP ---
        projectForm.addEventListener('submit', handleAddProject);
        initializeSupabase();

    </script>
</body>
</html>