<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenant Project Estimator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        /* Custom scrollbar for better aesthetics */
        /* Changes to allow creating projects and requirements */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .data-table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        /* Tailwind group-hover fix for complex dropdown */
        .group:hover .group-hover\:visible {
            visibility: visible;
            opacity: 1;
            transform: scale(1);
        }
        /* Active admin tab style */
        .admin-tab-btn.active {
            border-bottom-color: #4f46e5;
            color: #4f46e5;
        }
    </style>
</head>
<body>

    <div id="app-view" class="hidden min-h-screen">
        
        <header class="bg-white shadow-lg p-4 sticky top-0 z-10">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-extrabold text-blue-600">Tenant Project Planner</h1>

                <div class="flex items-center space-x-4">
                    <select id="project-selector" class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-sm">
                        <option value="">Select Active Project</option>
                        </select>

                    <div id="user-info" class="relative group">
                        <button class="flex items-center bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">
                            <span id="display-email" class="text-sm font-medium">Loading...</span>
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        
                        <div class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-xl z-20 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform scale-95 group-hover:scale-100 origin-top-right">
                            <a href="#" id="admin-settings-btn" class="hidden block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-lg">Admin Settings</a>
                            <a href="#" id="sign-out-btn" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-b-lg">Sign Out</a>
                            <span id="display-tenant-id" class="block px-4 py-2 text-xs text-gray-400 truncate">Tenant ID: </span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4 space-y-8">
            
            <section class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Tenant Projects & Priority</h2>
                <div id="priority-project-table-container" class="data-table-container">
                    <p class="text-gray-500">Loading project list...</p>
                </div>
            </section>

            <section class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-semibold text-gray-800">Requirements & Estimates</h2>
                    <button id="add-requirement-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-150 shadow-md text-sm font-medium" disabled>
                        + Add New Requirement
                    </button>
                </div>
                <div id="requirements-table-container" class="data-table-container">
                    <p class="text-gray-500">Select an active project above to view or add requirements.</p>
                </div>
            </section>

            <section class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Risks & Issues Tracker</h2>
                <div class="flex space-x-2 mb-4">
                    <button data-filter="all" class="risk-filter-btn px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition duration-150">All</button>
                    <button data-filter="risk" class="risk-filter-btn px-4 py-2 rounded-lg bg-yellow-500 text-white hover:bg-yellow-600 transition duration-150">Risks</button>
                    <button data-filter="issue" class="risk-filter-btn px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition duration-150">Issues</button>
                </div>
                <div id="risks-issues-table-container" class="data-table-container">
                    <p class="text-gray-500">Loading risks and issues...</p>
                </div>
            </section>
        </main>
    </div>

    <div id="auth-view" class="flex flex-col items-center justify-center min-h-screen bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-2xl">
            <h2 class="text-3xl font-bold text-center text-blue-600">Welcome Back</h2>
            <div id="auth-error-message" class="text-red-500 text-sm text-center hidden mb-4 p-2 bg-red-100 rounded-md border border-red-200"></div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" id="login-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">Sign In</button>
            </form>

            <p class="text-center text-sm text-gray-600">
                Don't have an account? 
                <button type="button" id="toggle-signup" class="text-blue-600 hover:text-blue-500 font-medium">Sign Up</button>
            </p>

            <form id="signup-form" class="space-y-4 hidden">
                <h3 class="text-xl font-semibold text-center text-gray-800 pt-4 border-t">New Tenant Registration</h3>
                <div>
                    <label for="signup-email" class="block text-sm font-medium text-gray-700">Email (Used for Login)</label>
                    <input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="signup-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" id="signup-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">Register New Tenant</button>
                <p class="text-center text-sm text-gray-600">
                    Already registered? 
                    <button type="button" id="toggle-login" class="text-blue-600 hover:text-blue-500 font-medium">Sign In</button>
                </p>
            </form>
        </div>
    </div>

    <div id="req-detail-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 relative max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-blue-600" id="req-modal-title">Requirement Details</h3>
            
            <form id="requirement-detail-form" class="space-y-4">
                <input type="hidden" id="req-id">
                <input type="hidden" id="req-project-id">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Requirement Name</label>
                        <input type="text" id="req-name" required class="mt-1 block w-full border border-gray-300 p-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Assigned To (User ID)</label>
                        <select id="req-assigned-to" class="mt-1 block w-full border border-gray-300 p-2 rounded-lg">
                            </select>
                    </div>
                </div>
                
                <h4 class="text-lg font-semibold mt-6 border-b pb-1">Sequencing & Estimation Steps</h4>
                <div id="step-list" class="space-y-3 p-3 border rounded-lg bg-gray-50">
                    </div>
                <button type="button" id="add-step-btn" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                    + Add Step
                </button>
                
                <div class="text-right pt-4 border-t">
                    <p class="text-lg font-bold">Total Estimated Cost: <span id="total-cost-display" class="text-green-600">$0.00</span></p>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="close-req-modal" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150">Cancel</button>
                    <button type="submit" id="save-req-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150">Save Requirement</button>
                </div>
            </form>
        </div>
    </div>

    <div id="admin-settings-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl p-6 relative max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-indigo-600">Admin Configuration</h3>
            
            <div class="flex border-b mb-4">
                <button data-tab="users" class="admin-tab-btn px-4 py-2 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600 active">User Management</button>
                <button data-tab="rates" class="admin-tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent">Rate Management</button>
            </div>
            
            <div id="admin-tab-users" class="admin-tab-content space-y-4">
                <h4 class="text-lg font-semibold">Invite New Tenant User</h4>
                <form id="invite-user-form" class="space-y-3 p-4 border rounded-lg bg-indigo-50">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">New User Email</label>
                        <input type="email" id="invite-email" required class="mt-1 block w-full border border-gray-300 p-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Role</label>
                        <select id="invite-role" required class="mt-1 block w-full border border-gray-300 p-2 rounded-lg">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150 text-sm font-medium">Send Invitation</button>
                </form>
                
                <h4 class="text-lg font-semibold pt-4 border-t">Current Tenant Users</h4>
                <div id="tenant-users-list" class="data-table-container">
                    <p class="text-gray-500">Loading user list...</p>
                </div>
            </div>

            <div id="admin-tab-rates" class="admin-tab-content space-y-4 hidden">
                <h4 class="text-lg font-semibold">Tenant-Wide Blended Rate</h4>
                <form id="blended-rate-form" class="space-y-3 p-4 border rounded-lg bg-green-50">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Rate ($/Hour)</label>
                        <input type="number" id="blended-rate" step="0.01" required class="mt-1 block w-full border border-gray-300 p-2 rounded-lg" value="50.00">
                    </div>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150 text-sm font-medium">Save Blended Rate</button>
                </form>
                
                <h4 class="text-lg font-semibold pt-4 border-t">Individual Resource Rates</h4>
                <form id="individual-rates-form" class="space-y-3 p-4 border rounded-lg bg-yellow-50">
                    <div id="individual-rates-list" class="space-y-2">
                        <p class="text-gray-600">No individual rates defined yet.</p>
                    </div>
                    <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition duration-150 text-sm font-medium">Save Individual Rates</button>
                </form>
            </div>

            <div class="flex justify-end pt-4">
                <button type="button" id="close-admin-modal" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150">Close</button>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // ==============================================
    // 1. Environments Setup and Globals
	// This should load new projects into the projects table
    // ==============================================
    
    // ** FINAL FIX: Vercel will replace these placeholders with the actual keys **
const SUPABASE_URL = 'https://xkwctrfmvpqpcrksrzgq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhrd2N0cmZtdnBxcGNya3NyemdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MTk0MTAsImV4cCI6MjA3OTI5NTQxMH0.i6GMjG1_APaiKc3UcJekxtFtAbPrykEkwSZUnusNvmY';

// Supabase client instance
let supabaseClient = null;
let currentTenantId = null; 
// ... (continue with the rest of your code)
    let currentTenantId = null;
    let currentUserId = null;
    let currentProjectID = null;
    let isUserAdmin = false;

    // --- Table/View names (Adjust as per your Supabase setup) ---
    const PROJECTS_TABLE = 'projects';
    const REQUIREMENTS_TABLE = 'requirements';
    const USERS_TABLE = 'tenant_users';
    const RATES_TABLE = 'rates';

    // --- Element References ---
    const authView = document.getElementById('auth-view');
    const appView = document.getElementById('app-view');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const toggleSignupBtn = document.getElementById('toggle-signup');
    const toggleLoginBtn = document.getElementById('toggle-login');
    const authErrorBox = document.getElementById('auth-error-message');
    const displayEmail = document.getElementById('display-email');
    const displayTenantId = document.getElementById('display-tenant-id');
    const signOutBtn = document.getElementById('sign-out-btn');
    const adminSettingsBtn = document.getElementById('admin-settings-btn');
    const projectSelector = document.getElementById('project-selector');
    const priorityProjectContainer = document.getElementById('priority-project-table-container');
    const requirementsContainer = document.getElementById('requirements-table-container');
    const addRequirementBtn = document.getElementById('add-requirement-btn');
    const reqDetailModal = document.getElementById('req-detail-modal');
    const adminSettingsModal = document.getElementById('admin-settings-modal');
    const blendedRateInput = document.getElementById('blended-rate');
	const risksIssuesContainer = document.getElementById('risks-issues-table-container');

    // ==============================================
    // 2. Utility Functions
    // ==============================================
	//Start new client-side UUID block
/**
 * Generates a simple, non-cryptographic UUID (v4 format) in the browser.
 */
function generateUUID() {
    // This is a common pattern for generating V4 UUIDs in JS
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}
    // End of new client-side UUID block
	// NOTE: Assuming 'authErrorBox' is your element for displaying messages
function displayAuthError(message, type = 'error') {
    // 1. Log to console only if it's a real error
    if (type === 'error') {
        console.error('Auth Error:', message);
        // Ensure error box is styled for errors
        authErrorBox.classList.remove('text-green-600');
        authErrorBox.classList.add('text-red-500'); 
    } else {
        // Style for success
        authErrorBox.classList.remove('text-red-500');
        authErrorBox.classList.add('text-green-600'); 
        console.log('Auth Success:', message); // Log success
    }

    // 2. Set the message content
    authErrorBox.textContent = message;
    
    // 3. Ensure the element is visible
    authErrorBox.classList.remove('hidden');
}

// NOTE: You may need to ensure your CSS defines 'text-red-500' and 'text-green-600'
// (These are common Tailwind CSS classes, adjust if you use standard CSS).
    
    function hideAuthError() {
        authErrorBox.classList.add('hidden');
        authErrorBox.textContent = '';
    }

    function toggleAppView(isAuthenticated, user) {
        if (isAuthenticated) {
            authView.classList.add('hidden');
            appView.classList.remove('hidden');
            currentUserId = user.id;
            // Assuming you have a 'tenant_id' in your users table/metadata
            currentTenantId = (user.user_metadata && user.user_metadata.tenant_id) || 'T-UNKNOWN';
            isUserAdmin = user.user_metadata && user.user_metadata.role === 'admin';
            displayEmail.textContent = user.email;
            displayTenantId.textContent = `Tenant ID: ${currentTenantId}`;
            
            if (isUserAdmin) {
                adminSettingsBtn.classList.remove('hidden');
            } else {
                adminSettingsBtn.classList.add('hidden');
            }

            // Load application data after successful authentication
            loadApplicationData();

        } else {
            authView.classList.remove('hidden');
            appView.classList.add('hidden');
            currentUserId = null;
            currentTenantId = null;
            isUserAdmin = false;
            // Reset UI state
            projectSelector.innerHTML = '<option value="">Select Active Project</option>';
            requirementsContainer.innerHTML = '<p class="text-gray-500">Select an active project above to view requirements.</p>';
        }
    }

    /**
     * Initializes the Supabase client.
     */
    function initializeSupabase() {
        try {
            if (SUPABASE_URL.startsWith('__SUPABASE')) {
                throw new Error("Supabase URL or Anon Key is missing. Check Vercel environment variables.");
            }
            
            // Create the client instance
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // Assign to window for easier access/debugging
            window.supabase = supabaseClient;
            
            // Start the auth flow
            checkAuthStatus();
        } catch (err) {
            displayAuthError(`Initialization Error: ${err.message}`);
        }
    }
    
    // ==============================================
    // 3. Authentication Handlers
    // ==============================================

    async function checkAuthStatus() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        toggleAppView(!!user, user);
    }


    async function handleLogin(e) {
    e.preventDefault();
    hideAuthError();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const loginBtn = document.getElementById('login-btn');

    loginBtn.textContent = 'Logging in...';
    loginBtn.disabled = true;

    // 1. Attempt Sign-in
    const { data: signInData, error: signInError } = await supabaseClient.auth.signInWithPassword({
        email: email,
        password: password,
    });
    
    // Reset button state and clear fields immediately
    loginBtn.textContent = 'Log In';
    loginBtn.disabled = false;
    document.getElementById('login-password').value = ''; 

    if (signInError) {
        // Handle explicit error from the server
        displayAuthError(`Login Failed: ${signInError.message}`);
        return;
    } 
    
    // 2. Check for session data from the result OR force check local storage.
    let session = signInData.session;

    if (!session) {
        // If the session wasn't returned, force a check of the browser's local storage.
        const { data: sessionData } = await supabaseClient.auth.getSession();
        session = sessionData.session;
    }

    if (session) {
        // SUCCESS: Session established. Redirect the user.
        window.location.assign("/dashboard.html"); // Replace with your target page
    } else {
        // FAIL: Session was not created, despite successful credentials.
        // This MUST display an error, ruling out silent failures.
        displayAuthError("Login successful but no session was issued. Please check if your email is confirmed.", 'error');
    }
}
    async function handleSignup(e) {
    e.preventDefault();
    hideAuthError();
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    const signupBtn = document.getElementById('signup-btn');

    signupBtn.textContent = 'Registering...';
    signupBtn.disabled = true;

    // 1. Generate the initial tenant_id UUID
    const newTenantId = generateUUID();

    // 2. Call Supabase signUp with the generated UUID in user_metadata
    const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({ 
        email, 
        password,
        options: { 
            data: { 
                tenant_id: newTenantId, 
                role: 'admin' 
            } 
        }
    });

    if (signUpError) {
        displayAuthError(`Signup Failed: ${signUpError.message}`);
    } else {
        // --- SUCCESS LOGIC: Display Email Confirmation Message ---
        let successMessage = `Success! Check your email at **${email}** to confirm your account and log in.`;

        // Hide the signup form and show the login form for the next step (login)
        // NOTE: We call toggleSignupForm(false) if that's your function for switching, 
        // otherwise we manually hide/show the elements as shown below.
        
        // Assuming toggleSignupForm(false) works to switch back:
        toggleSignupForm(false); 
        
        // OR, if you don't use toggleSignupForm:
        // loginForm.classList.remove('hidden');
        // signupForm.classList.add('hidden');
        // toggleSignupBtn.parentElement.classList.remove('hidden');

        // Display the success message using a 'success' type
        displayAuthError(successMessage, 'success'); 
        
        // Clear the signup form fields
        document.getElementById('signup-email').value = '';
        document.getElementById('signup-password').value = '';
    }

    signupBtn.textContent = 'Register New Tenant';
    signupBtn.disabled = false;
}

    async function handleSignOut() {
        await supabaseClient.auth.signOut();
        toggleAppView(false);
        hideAuthError(); // Clear any lingering error message
    }

    function toggleSignupForm(showSignup) {
        if (showSignup) {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            toggleSignupBtn.parentElement.classList.add('hidden');
        } else {
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
            toggleSignupBtn.parentElement.classList.remove('hidden');
        }
    }

    // ==============================================
    // 4. Application Data Logic
    // ==============================================

    async function loadApplicationData() {
        await fetchProjects();
        await fetchTenantUsers();
        
        // If a project is selected (e.g., from local storage or previous session), load its requirements
        if (currentProjectID) {
            await fetchRequirements(currentProjectID);
        }
        // For this simple demo, we'll just load the priority table
        renderPriorityTablePlaceholder();
        renderRisksIssuesPlaceholder();
    }

    /**
     * Fetches and populates the Project Selector in the header.
     * If no projects are found, it triggers the empty state UI.
     */
    async function fetchProjects() {
        // In a multi-tenant app, filter by the currentTenantId
        const { data, error } = await supabaseClient
            .from(PROJECTS_TABLE)
            .select('id, name')
            // Assuming RLS policy filters by tenant_id
            .order('name', { ascending: true }); 

        if (error) {
            console.error('Error fetching projects:', error);
            projectSelector.innerHTML = '<option value="">Error Loading Projects</option>';
            return;
        }
			allProjects = data;
        // Clear and repopulate the selector
        projectSelector.innerHTML = '<option value="">Select Active Project</option>';

        // === NEW LOGIC: Handle Empty State ===
        if (data.length === 0) {
            handleEmptyProjects(); 
            return; 
        }
        // =====================================

        // Existing logic to populate dropdown if data is found:
        data.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            projectSelector.appendChild(option);
        });

        // Optionally: Automatically select a project if one exists (e.g., the first one)
    //  if (data.length > 0 && !currentProjectID) {
    //      projectSelector.value = data[0].id;
            // Manually trigger the selection handler for the first project
    //      handleProjectSelection({ target: projectSelector });
    //  }
    } 

    /**
     * Handles project selection change.
     */
    async function handleProjectSelection(e) {
        currentProjectID = e.target.value;

        if (currentProjectID) {
            await fetchRequirements(currentProjectID); 
            addRequirementBtn.disabled = false;
        } else {
            requirementsContainer.innerHTML = '<p class="text-gray-500">Select an active project above to view or add requirements.</p>';
            addRequirementBtn.disabled = true;
        }
    }
    
    /**
     * Inserts a new project row into the Supabase database.
     * @param {string} title - The title of the new project.
     */
   async function createProjectInDatabase(title) {
    if (!currentTenantId) {
        console.error("Cannot create project: Tenant ID is unknown.");
        alert("Error: Cannot create project without a valid Tenant ID.");
        return { error: { message: "Tenant ID missing" } };
    }

    const { data, error } = await supabaseClient
        .from(PROJECTS_TABLE)
        .insert([
            {
                name: title,
                tenant_id: currentTenantId, // Ensure RLS policy compliance
                status: 'Active', // Default status
                priority_value: 1 // **ADDED: Fixes "null value in column 'priority_value'" error**
            }
        ])
        .select();

    if (error) {
        console.error('Supabase Insert Error:', error);
        alert(`Error creating project: ${error.message}`);
        return { error };
    }
    
    // Return the newly created project data
    return { data: data[0] };
}

    /**
     * Updates the UI when no projects are found for the tenant.
     */
    function handleEmptyProjects() {
        // 1. Clear project selector
        projectSelector.innerHTML = '<option value="">No Projects Found</option>';
        
        // 2. Update the requirements container to show the creation prompt
        requirementsContainer.innerHTML = `
            <div class="text-center py-10 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                <h3 class="text-lg font-semibold text-gray-700">No Projects Found for your Tenant</h3>
                <p class="text-sm text-gray-500 mt-2">To get started, please create your first project.</p>
                <button id="create-first-project-btn" 
                        class="mt-4 px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition">
                    + Create New Project
                </button>
            </div>
        `;
        
        // 3. Disable the main "Add Requirement" button
        addRequirementBtn.disabled = true;

        // 4. Attach a listener to the new button
        document.getElementById('create-first-project-btn').addEventListener('click', () => {
            showProjectModal(); 
        });
    }

    /**
     * Handles the display of the Project Creation/Edit Modal.
     * LOGIC UPDATED TO PERFORM REAL DATABASE INSERT.
     */
    async function showProjectModal(projectId = null) {
        // For now, use a prompt and actually insert the project:
        const projectTitle = prompt("Enter a title for your new project:");

        if (projectTitle && projectTitle.trim() !== '') {
            
            // --- START REAL INSERT LOGIC ---
            const { data: newProject, error } = await createProjectInDatabase(projectTitle);

if (!error) {
    alert(`Project "${projectTitle}" successfully created! Loading project details.`);
    
    // --- START CRITICAL FIX LOGIC ---

    // 1. Re-run fetchProjects to load the new project and update the dropdown
    await fetchProjects(); // Wait for the dropdown options to be updated

    if (newProject) {
        // 2. Automatically select the newly created project
        // This line attempts to set the value. It requires 'fetchProjects' to have updated the options.
        projectSelector.value = newProject.id; 

        // 3. Manually ensure the global state reflects the selected project
        // This is the missing link. We must find the new project in the list
        // and set the global variables (like currentProjectID) that the controls rely on.
        
        // Assuming your project list is stored globally as 'allProjects':
        const selectedProject = allProjects.find(p => p.id === newProject.id);

        if (selectedProject) {
            currentProjectID = selectedProject.id;
            // The controls depend on the side effect of handleProjectSelection, which
            // likely sets the global state variables required by the other page controls.
            handleProjectSelection({ target: projectSelector }); 
        }
    }
            // --- END REAL INSERT LOGIC ---
        }
    }
    
    /**
     * Fetches and renders requirements for the selected project.
     */
    async function fetchRequirements(projectId) {
        requirementsContainer.innerHTML = `<p class="text-gray-500">Loading requirements for Project ${projectId}...</p>`;
        
        // Fetch requirements linked to the project
        const { data, error } = await supabaseClient
            .from(REQUIREMENTS_TABLE)
            .select(`
                id, name, estimated_cost, status, assigned_to,
                tenant_users!inner(email)
            `)
            .eq('project_id', projectId)
            .order('id', { ascending: true });

        if (error) {
            requirementsContainer.innerHTML = `<p class="text-red-500">Error fetching requirements: ${error.message}</p>`;
            return;
        }

        renderRequirementsTable(data);
    }

    function renderRequirementsTable(requirements) {
        if (requirements.length === 0) {
            requirementsContainer.innerHTML = '<p class="text-gray-400 text-center py-8 italic">No requirements defined for this project. Click "+ Add New Requirement" to begin.</p>';
            return;
        }

        let html = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Est. Cost</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
        `;

        requirements.forEach(req => {
            const assignedEmail = req.tenant_users.email || 'Unassigned';
            const statusColor = { 'Planned': 'text-blue-500', 'In Progress': 'text-yellow-600', 'Complete': 'text-green-600' }[req.status] || 'text-gray-500';
            
            html += `
                <tr data-req-id="${req.id}" class="hover:bg-gray-50 transition duration-100">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${req.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${assignedEmail}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusColor}">${req.status}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-right text-green-700">$${(req.estimated_cost || 0).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="edit-req-btn text-indigo-600 hover:text-indigo-900" data-id="${req.id}">Edit</button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        requirementsContainer.innerHTML = html;
        attachRequirementTableListeners();
    }

    /**
     * Placeholder functions for other tables (for a complete UI, these would call fetch/render functions)
     */
    function renderPriorityTablePlaceholder() {
        priorityProjectContainer.innerHTML = `
            <table class="min-w-full divide-y divide-gray-200">
                <tbody>
                    <tr><td class="px-6 py-2 text-sm text-gray-500">Project Alpha: High Priority - $50,000</td></tr>
                    <tr><td class="px-6 py-2 text-sm text-gray-500">Project Beta: Medium Priority - $20,000</td></tr>
                </tbody>
            </table>
        `;
    }
    
    function renderRisksIssuesPlaceholder() {
        document.getElementById('risks-issues-table-container').innerHTML = `
            <ul class="space-y-2">
                <li class="p-3 bg-yellow-100 border border-yellow-200 rounded-md text-sm">Risk: Scope Creep (High Impact) - Mitigation: Change Request Process</li>
                <li class="p-3 bg-red-100 border border-red-200 rounded-md text-sm">Issue: Resource Unavailable (Blocker) - Action: Recruit Contract Dev</li>
            </ul>
        `;
    }

    // ==============================================
    // 5. Modal & Form Logic (Simplified)
    // ==============================================

    function attachRequirementTableListeners() {
        document.querySelectorAll('.edit-req-btn').forEach(button => {
            button.onclick = (e) => {
                e.preventDefault();
                // In a real app, this would fetch requirement details by ID and populate the modal
                showRequirementModal(button.getAttribute('data-id'));
            };
        });
    }

    function showRequirementModal(reqId = null) {
        const form = document.getElementById('requirement-detail-form');
        form.reset();
        document.getElementById('req-id').value = reqId || '';
        document.getElementById('req-project-id').value = currentProjectID;
        document.getElementById('req-modal-title').textContent = reqId ? 'Edit Requirement' : 'Add New Requirement';
        document.getElementById('save-req-btn').textContent = reqId ? 'Update Requirement' : 'Save Requirement';
        
        // Clear and add one default step for new requirements
        const stepList = document.getElementById('step-list');
        stepList.innerHTML = ''; 
        if (!reqId) {
            addStepInput();
        }

        reqDetailModal.classList.remove('hidden');
    }

    function closeRequirementModal() {
        reqDetailModal.classList.add('hidden');
    }

    function addStepInput() {
        const stepList = document.getElementById('step-list');
        const stepIndex = stepList.children.length;
        const stepDiv = document.createElement('div');
        stepDiv.className = 'flex space-x-2 items-center';
        stepDiv.innerHTML = `
            <input type="text" placeholder="Step Description" required class="flex-1 border border-gray-300 p-2 rounded-lg text-sm" name="step-desc-${stepIndex}">
            <input type="number" step="0.5" placeholder="Hours" required class="w-20 border border-gray-300 p-2 rounded-lg text-sm" name="step-hours-${stepIndex}" value="8">
            <input type="number" step="0.01" placeholder="Cost ($)" required class="w-24 border border-gray-300 p-2 rounded-lg text-sm" name="step-cost-${stepIndex}" value="400.00">
            <button type="button" class="remove-step-btn text-red-500 hover:text-red-700 transition">×</button>
        `;
        stepList.appendChild(stepDiv);
        
        stepDiv.querySelector('.remove-step-btn').onclick = () => {
            stepList.removeChild(stepDiv);
            calculateTotalCost();
        };
        
        stepDiv.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', calculateTotalCost);
        });

        calculateTotalCost();
    }
    
  function calculateTotalCost() { 
    const stepList = document.getElementById('step-list');
    let totalCost = 0;

    stepList.querySelectorAll('input[name^="step-cost-"]').forEach(input => {
        totalCost += parseFloat(input.value) || 0;
    });

    document.getElementById('total-cost').textContent = `$${totalCost.toFixed(2)}`;
}

    // ==============================================
    // 6. Admin Logic (Simplified)
    // ==============================================

    function showAdminModal() {
        adminSettingsModal.classList.remove('hidden');
    }

    function closeAdminModal() {
        adminSettingsModal.classList.add('hidden');
    }

    function handleAdminTabClick(e) {
        document.querySelectorAll('.admin-tab-btn').forEach(btn => {
            btn.classList.remove('active', 'border-indigo-600', 'text-indigo-600');
            btn.classList.add('text-gray-500', 'border-transparent');
        });
        e.target.classList.add('active', 'border-indigo-600', 'text-indigo-600');
        e.target.classList.remove('text-gray-500', 'border-transparent');

        document.querySelectorAll('.admin-tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(`admin-tab-${e.target.dataset.tab}`).classList.remove('hidden');
    }

    async function fetchTenantUsers() {
        // Placeholder: In a real app, this fetches users for the current tenant.
          const list = document.getElementById('tenant-users-list');
          list.innerHTML = `
              <ul class="divide-y divide-gray-200">
                  <li class="py-2 text-sm">user@tenant.com (Admin)</li>
                  <li class="py-2 text-sm">dev@tenant.com (User)</li>
              </ul>
          `;
          
          // Populate assigned-to dropdown in requirement modal
          const assignedSelect = document.getElementById('req-assigned-to');
          assignedSelect.innerHTML = '<option value="">Unassigned</option>';
          assignedSelect.innerHTML += '<option value="user_id_1">user@tenant.com</option>';
          assignedSelect.innerHTML += '<option value="user_id_2">dev@tenant.com</option>';
    }

    // ==============================================
    // 7. Event Listeners & Startup
    // ==============================================

    // --- Auth Listeners ---
    loginForm.addEventListener('submit', handleLogin);
    signupForm.addEventListener('submit', handleSignup);
    toggleSignupBtn.addEventListener('click', () => toggleSignupForm(true));
    toggleLoginBtn.addEventListener('click', () => toggleSignupForm(false));
    signOutBtn.addEventListener('click', handleSignOut);
    
    // --- App Listeners ---
    projectSelector.addEventListener('change', handleProjectSelection);
    adminSettingsBtn.addEventListener('click', showAdminModal);
    
    // --- Modal Listeners: Requirement ---
    addRequirementBtn.addEventListener('click', () => showRequirementModal());
    document.getElementById('close-req-modal').addEventListener('click', closeRequirementModal);
    document.getElementById('add-step-btn').addEventListener('click', addStepInput);
    document.getElementById('requirement-detail-form').addEventListener('submit', (e) => {
          e.preventDefault();
          // Logic to save the requirement using Supabase here
          alert('Requirement data simulated to be saved!');
          closeRequirementModal();
    });

    // --- Modal Listeners Here: Admin ---
    document.getElementById('close-admin-modal').addEventListener('click', closeAdminModal);
    document.querySelectorAll('.admin-tab-btn').forEach(btn => {
        btn.addEventListener('click', handleAdminTabClick);
    });
    document.getElementById('blended-rate-form').addEventListener('submit', (e) => {
        e.preventDefault();
        alert(`New Blended Rate: $${blendedRateInput.value} saved.`);
    });

    // --- STARTUP ---
    initializeSupabase();
}
</script>
</body>
</html>